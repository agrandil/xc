# Nama workflow yang akan tampil di tab Actions
name: Auto Commit Log File with Calculation

# Pemicu (trigger) untuk menjalankan workflow ini
on:
  schedule:
    # Berjalan setiap 5 menit menggunakan syntax cron
    - cron: '*/5 * * * *'
  
  # Baris ini memungkinkan Anda menjalankan workflow secara manual dari tab Actions
  # Sangat berguna untuk melakukan tes tanpa harus menunggu jadwal
  workflow_dispatch:

# Daftar pekerjaan (jobs) yang akan dijalankan
jobs:
  auto_commit_job:
    # Menentukan bahwa job ini berjalan di mesin virtual Ubuntu versi terbaru
    runs-on: ubuntu-latest

    # Langkah-langkah yang akan dieksekusi secara berurutan
    steps:
      # Langkah 1: Melakukan "checkout" atau mengunduh kode dari repositori Anda
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Menggunakan token khusus agar workflow ini punya izin untuk melakukan 'push'
          token: ${{ secrets.GITHUB_TOKEN }}

      # Langkah 2: Mengatur identitas Git untuk commit yang akan dibuat.
      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      # Langkah 3: Lakukan operasi dengan mekanisme coba lagi (retry) untuk menghindari konflik
      - name: "Pull, Modify, Commit, and Push with Retry"
        run: |
          # Mencoba proses hingga 3 kali
          for i in 1 2 3
          do
            # **PERBAIKAN UTAMA:** Selalu mulai dengan menyinkronkan DULU
            git pull
            
            # SEKARANG baru buat perubahan pada file
            HASIL=$((100 / 5 * 1000))
            echo "Perhitungan otomatis pada $(date): 100 / 5 * 1000 = $HASIL" >> log.txt

            # Commit dan coba push
            git add log.txt
            git commit -m "docs: Perbarui log.txt dengan hasil perhitungan [ci skip]"
            
            # Jika push berhasil, keluar dari skrip dengan status sukses
            git push && exit 0
            
            # Jika push gagal, berarti ada race condition.
            # Ulangi proses dari awal setelah reset dan jeda singkat.
            echo "Push gagal. Mencoba lagi setelah reset..."
            git reset --hard HEAD~1
            sleep 5
          done
          
          # Jika semua percobaan gagal, keluar dengan status error
          echo "Gagal melakukan push setelah beberapa kali percobaan."
          exit 1
